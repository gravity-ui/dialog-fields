## Общая информация

Компонент `Dialog` предназначен для имплементации модальных форм (диалогов) на базе react-final-form. Каждое поле -
это отдельный компонент и должно быть зарегистрированно заранее с помощью метода
`Dialog.registerControl(controlId, controlComponentClass)`. Далее список конфигураций-объектов для каждого поля
передаётся как свойство `fields` компонента, где ключ `type` должен совпадать с `controlId` одного из зарегистрированных
компонентов, остальные ключи будут описаны ниже.

## Требования к классам виджетов

Помимо стандартных требований к классам компонентов (наследование от `React.Component`, наличие метода `render`) есть
управляющий контейнер `Dialog` налагает несколько дополнительных требований:

- наличие метода `static getDefaultValue(field)`, который возвращает значение поля по умолчанию, т.е. в случае, если это
  поле не инициализировано стартовым значением в `Dialog` с помощью `initialValues` или `initialTabs` (о них - ниже);
- наличие метода `static isEmpty(value, field)`, который тестирует поле на пустоту, пустота поля приводит к срабатыванию
  стандартный валидатор required-полей
- опциональный метод `static renderLabel(field)`, при наличии которого лейбл поля в форме будет сгенерирован этим методом,
  а не получен стандартным образом из ключа `caption` конфигурации поля.

## PropTypes

| Property            | Type            | Required | Default     | Description                                                                                                                                                                                          |
| :------------------ | :-------------- | :------: | :---------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| visible             | `Boolean`       |    да    |             | Показывать модал или нет                                                                                                                                                                             |
| modal               | `Boolean`       |          | `true`      | Расположить в модальном окне или на странице                                                                                                                                                         |
| headerProps         | `Object`        |    да    |             | Свойства заголовка                                                                                                                                                                                   |
| footerProps         | `Object`        |          |             | Свойства подвала                                                                                                                                                                                     |
| onClose             | `Function`      |    да    |             | Колбэк, вызываемый по нажатию крестика в заголовке или кнопки Cancel                                                                                                                                 |
| onAdd               | `Function`      |    да    |             | Колбэк, вызываемый при нажатии на кнопку Submit. Ожидается, что он возвращает Promise-подобный объект, при наличии ошибок серверной валидации промис ресолвится в объект с ключом `validationErrors` |
| fields              | `Array`         |    да    |             | Список объектов-конфигураций по каждому полю, описание в отдельной таблице.                                                                                                                          |
| initialValues       | `Object`        |          | `{}`        | Стартовые значения формы в случае одного таба, взаимоисключает `initialTabs`.                                                                                                                        |
| pristineSubmittable | `Boolean`       |          | `false`     | Можно ли нажимать кнопку Submit сразу после рендеринга формы (мы в ней еще ничего не меняли).                                                                                                        |
| isApplyDisabled     | `Function`      |          | `undefined` | Колбэк, позволяющий клиенту управлять доступностью кнопки Submit. По умолчанию используется встроенный метод `isApplyDisabled`.                                                                      |
| waitingMessage      | `String`/`Node` |          | `undefined` | Сообщение, которое показывается, если сабмит формы длится больше 10 секунд.                                                                                                                          |
| validate            | `Funcion`       |          | `undefined` | Функция валидации всего состояния диалога, рекомендуется использовать в случае наличия табов                                                                                                         |
| virtualized         | `Boolean`       |   нет    | `false`     | Флаг включающий виртуализацию табов. При включении нужно использовать `Dialog.props.validate`, т.к. валидаторы полей для неактивных табов не вызываются                                              |

## PropTypes headerProps

| Property     | Type            | Required | Default | Description                          |
| :----------- | :-------------- | :------: | :------ | :----------------------------------- |
| title        | `String`        |    да    |         | Заголовок модала                     |
| insertAfter  | `String`/`Node` |          |         | Элемент для вставки после заголовка  |
| insertBefore | `String`/`Node` |          |         | Элемент для вставки перед заголовком |

## PropTypes footerProps

| Property   | Type     | Required | Default   | Description                                 |
| :--------- | :------- | :------: | :-------- | :------------------------------------------ |
| textCancel | `String` |          | `Cancel`  | Текст кнопки отмены                         |
| textApply  | `String` |          | `Confirm` | Текст кнопки сабмита                        |
| content    | `Node`   |          |           | Содержимое футера с левой стороны от кнопок |

## Синтаксис fields

Конфигурация каждого поля может иметь одну из структур:

```js
    const FIELD_TYPE = PropTypes.shape({
        name: PropTypes.string.isRequired,
        type: PropTypes.string.isRequired,
        required: PropTypes.bool,
        validator: PropTypes.func,
        caption: PropTypes.string,
        tooltip: PropTypes.string,
        warning: PropTypes.oneOfType([PropTypes.string, PropTypes.node]),
        placeholder: PropTypes.string,
        className: PropTypes.string,
        visibilityCondition: PropTypes.shape({
            when: PropTypes.string,
            isActive: PropTypes.any
        }),
        subscribers: PropTypes.object,
        extras: PropTypes.object,
        onChange: PropTypes.func,
        touched: PropTypes.boolean,
    });

    static SEPARATOR_TYPE = PropTypes.shape({
        separator: PropTypes.bool.isRequired,
    });

    static SECTION_TYPE = PropTypes.shape({
        section: PropTypes.string.isRequired,
        fields: PropTypes.arrayOf(
            PropTypes.oneOfType([Dialog.FIELD_TYPE, Dialog.SEPARATOR_TYPE]),
        ),
        wrapTo: PropTypes.func,
    });
```

Конфигурация `SECTION_TYPE` используется для определения заголовков фрагментов формы и объединения их в группы.
Конфигурация `FIELD_TYPE` используется для задания полей формы. Её ключи имеют следующий смысл:

- `name` - имя поля, используется в основном внутри `Dialog` для доступа к данным и привязывания тегов `<label>` к
  полям ввода.
- `type` - тип поля, должен быть предварительно зарегистрирован с помощью `Dialog.registerControl`.
- `required` - является поле обязательным или нет. Если является, то на него дополнительно вешается валидатор
  `required`, также такое поле помечается красной звёздочкой.
- `validator` - специфический валидатор-колбэк на данное поле для клиентской валидации. Если валидация прошла, нужно
  вернуть `undefined`, в противном случае надо вернуть строку с ошибкой валидации, ошибки валидации будут отображаться
  только на текущем табе, для валидации всего состояния диалога нужно использовать `Dialog.props.validate`
- `validateFields` - список полей которые нужно провалидировать при изменении текущего поля, по умолчанию [];
- `caption` - лейбл данного поля в форме (если виджет не имплементирует метод `static renderLabel()`).
- `tooltip` - при наличии такой строки рядом с лейблом рисуется иконка вопроса, при наведении на которую данная строка
  показывается тултипом.
- `warning` - при наличии такого свойства под контролом рисуется иконка предупреждения и значение данного свойства,
  которое может быть строкой или react элементом.
- `placeholder` - строка, показываемые в пустом поле ввода.
- `className` - строка, которая будет задана полю в качестве класса.
- `visibilityCondition` - обьект, содержащий условие видимости поля, содержит имя наблюдаемого поля и
  функцию с валидацией его значения.
- `subscribers` - обьект, где ключ - это поле-подписчик, а значение - функция, вычисляющая новое значение поля-подписчика.
  Функция принимает значение наблюдаемоего поля и все значения полей в форме.
- `extras` - объект или функция получающая значения формы и возвращающая объект, в который можно положить дополнительные данные для контрола. Например список всех айтемов в селекте.
- `onChange` - функция колбек для реакции на изменение

В стандартной поставке `Dialog` имплементированы следующие поля:

- `type: text`, виджет `TextControl` - обычное текстовое поле ввода (с поддержкой валидации)
- `type: textarea`, виджет `TextAreaControl` - большое текстовое поле ввода (с поддержкой валидации)
- `type: abc`, виджет `AbcSuggestControl` - саджест сервисов по каталогу ABC. Т.к. нынешний API сервиса ABC не
  поддерживает в достаточной мере инкрементальный поиск по имени сервиса, используется поиск по API Стаффа, с фильтром по
  группам типа `"service"`.
- `type: staff`, виджет `StaffSuggestControl` - саджест пользователей и групп пользователей по API Стаффа.
- `type: responsibles`, виджет `ResponsiblesControl` - надстройка над `StaffSuggestControl`, которая позволяет выбирать
  произвольное количество пользователей.
- `type: block`, виджет `CustomBlock` - используется для отображения ошибок, предупреждений.
- `type: plain`, виджет `PlainText` - используется для отображения текстовых неизменяемых значений, хранится в
  результатах сабмита.
- `type: checkbox`, виджет `CheckBoxControl` - обычный чекбокс
- `type: tumbler`, виджет `TumblerControl` - аналог чекбокса
- `type: radio`, виджет `RadioButtonControl` - контрол для выбора из небольшого списка доступных значений
- `type: select`, виджет `SelectControl` - контрол для выбора из списка доступных значений
- `type: until-date`, контрол `IdmDatePicker` - альтернативный контрол выбора даты, также позволяет задавать дату указав количество дней до даты,
  кроме того поддерживается специальное значение бесконечность (null/undefined)
- `type: editable-list`, виджет позволяющий отмечать элементы списка как удаляемые
- `type: multi-editable-lists`, по сути это список из нескольких `editable-list`-ов, нужен для выравнивания списков

Также `Dialog` поддерживает возможность описания содержимого табов, для этого есть:

- `type: tab` (TabField)
- `type: tab-vertical` (TabFieldVertical);

Табы всегда должны быть на верхнем уровне свойства fields. При этом если первый элемент
в свойстве fileds является табом, то все элементы верхнего уровня должны быть табами такого же типа.

## Области для улучшения

- waitingMessage выглядит очень специфичным кейсом - по возможности, лучше вынести в клиентский код
- конкретный способ рендеринга многотабовых полей лучше вынести в клиентский код
- выбор между простым и многотабовым отображением может быть лучше осуществлять на основе `fields`, а не на основе
  наличия `initialTabs`
